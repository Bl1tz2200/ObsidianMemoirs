Jenkins - удобная утилита, где через графический интерфейс можно настроить полный цикл CI/CD, однако для написания сложных Pipelines требуется знание их языка Groovy. Jenkins - полностью бесплатная утилита для CI/CD написанная на JAVA (работает только на JAVA 17)

# Установка и плагины
Jenkins скачивается почти пустой, поэтому необходимо скачивать плагины на него. Для этого, после установки и запуска сервиса jenkins, заходим на 8080 порт jenkins. Рекомендую нажимать на Install sugested plaguins, потому что в них входят все необходимые плагины для работы с гитхабом, однако второй выбор необходим для более точной настройки установки: там мы сами указываем: что нам надо

# Параметры
В настройках Jenkins можно задавать множество параметров, от выводимой информации до глобальных переменных, можно указывать какие Node будут запускаться (можно поставить запуск только тех, что соответствуют указанному label)

## Плагины
В настройках можно устанавливать плагины, необходимые для вас и вашей работы (сохраняются они в /var/lib/jenkins/plugins)

## System information
Блок System information показывает все параметры нашего сервера (даже переменные окружения)

## Tools and Actions
В графе Tools and Actions есть кнопки, отвечающие за управление самого Jenkins, в том числе и доступ к Jenkins CLI, которая позволяет полностью управлять Jenkins через его консоль

# Job
Создание job не требует особых сил: достаточно просто в GUI создать его и в Build Steps указать: что должно произойти (например вывестись Hello World)
Такие job будут выполнены на локальном компе от имени пользователя jenkins и сохраняются job в /var/lib/jenkins/jobs

В настройках job в Discard Old Builds можно задать максимальное количество build для хранения, чтобы не забить память логами виртуалки

# Передача по ssh
Для передачи данных на другой комп по ssh необходим плагин Publish Over SSH, позволяющий нам в действиях после выполнения кода, отправлять файлы по SSH
Однако для него требуется аутентификация по Secret Key, который нужно с IP адресов задать в настройках

# Создание Node
Для создания Node нужно зайти в настройки и найти Nodes, после чего можно будет создать новый узел на котором мы будем запускать job и pipeline

Другие Node - важная часть для запуска, ведь мы можем запускать их на удаленных компах с установленной java. Так можно будет распределить обязанности по разным Node для облегчения чтения инфраструктуры
## Label
Label используются для определения Node, поэтому лучше их указывать, так как именно через них мы можем запускать job и pipelines с разных Node

Для указания нескольких label нужно использовать пробел: label_1 label_2 label_2a (3 разных label) 

## Master и Slave
Частая практика использования Jenkins Master и Jenkins Slave, то есть использование главного Jenkins сервера (Master), с помощью которого мы отправляем задания на более мелкие (Slave). Именно для этого и нужно назначение job и pipelines с разных Node

# Jenkins CLI
Jenkins CLI позволяет полностью управлять Jenkins с помощью команд. Установить командную строку Дженкинса можно через настройки

## Аутентификация
В качестве аутентификации лучше всего создавать нового пользователя, специального для командной строки, а ещё лучше вместо пароля использовать token. После этого рекомендуется сохранить их в переменных окружения (глобальных переменных):

```
export JENKINS_USER_ID=user1
export JENKINS_API_TOKEN=11ec9efd57a81b8dc26e728e7558b756b5
```

## Команды CLI
С помощью CLI можно выполнять множество команд, по типу импорта job в файл:

```
java -jar jenkins-cli.jar -s http://192.168.1.76:8080 get-job My-Job-1 > myjob.xml
```

Создавать job:

```
java -jar jenkins-cli.jar -s http://192.168.1.76:8080 create-job My-Job-1.1 < myjob.xml
```

А вообще, в той же графе со скачиванием Jenkins CLI есть документация на все её команды.

# Jenkins + Github
Для использования Jenkins в сочетании с GitHub не требуется особых усилий, самая главная проблема: задать ssh ключи для git

Для начала установим git, затем необходимо зайти за пользователя jenkins:

```
sudo -iu jenkins
```

После создадим пару публичный/приватный ключ

```
ssh-keygen
```

Публичный ключ (c припиской .pub) мы копируем в настройки github в ssh ключ, 
затем запускаем к нашему репозиторию, с которым мы будем работать

```
git ls-remote -h SSH_ССЫЛКА_НА_ВАШ_РЕПОЗИТОРИЙ
```
 
После этого пишем yes и всё готово. Осталось задать git в настройках нашего job и он автоматически склонируется при запуске job
(Ах да, надо ещё добавить приватный ключ в настройки Jenkins)

# Jenkins Job Triggers
Jenkins Job Triggers - триггеры, которые автоматически запустят job, они задаются в самом job

По стандарту там не много триггеров:
- Запуск по ссылке (Trigger builds remotely)
- Запускать периодически (Build periodically)
 - Запускать после остановки другого job (Build after other projects are built)
- Запускать есть кто-то сделал push на репозиторий (GitHub hook trigger for GITScm polling)
- Запускать при изменении репозитория в гитхабе (Poll SCM) 

## Github hook trigger for GITScm polling
Для использования GitHub hook trigger for GITScm polling необходимо иметь Jenkins на белом ip адресе, так как помимо того, что нам нужно указать это обновление в Jenkins, необходимо ещё и в настройках репозитория в гитхабе, в графе WebHooks указать ссылку на наш Jenkins в виде:
 
```
http://192.168.1.76:8080/github-webhook/
```
 
/ - в конце обязателен
Content-type нужно указать json
 
После этого гитхаб при push на эту директорию будет отправлять post запрос на Jenkins, который, в свою очередь, будет запускать job

## Poll SCM
У Poll SCM нужно указать частоту проверки репозитория, его отличие от GitHub hook trigger for GITScm polling в том, что он реагирует только на изменения репозитория (то есть commit и push), а GitHub hook trigger for GITScm polling только на post запрос, отправленный от github
# Параметры Jenkins
В Jenkins можно указывать разные параметры: для этого нужно нажать галочку в This project is parameterized. Параметры необходимо будет изменять со значений по умолчанию перед запуском job, то есть перед build

# Jenkins Script Console
Jenkins Script Console - консоль внутри Jenkins, с помощью которой можно сделать буквально все, что угодно. Работает она на языке Groovy, который напоминает Java
Вот примеры нескольких команд:
 
```
println("Hello World!") // Вывод текста
```
 
```
"ls /".execute().text // Выполнение команды оболочки, а затем вывод её результата в виде текста
```

```
new File("${Jenkins.instance.root}/credentials.xml").text // Вывод файла в виде текста (аналог cat), для использования переменные ${}
```

```
Jenkins.instance.metaClass.methods*.name // Вывод всех возможных методов 
```

```
job = Jenkins.instance.getItemByFullName("My_Job_1") // Вводим в переменную job id My_Job_1
job.getBuilds().each { // Используем цикл for in
 println("Build " + it + " Result " + it.result) // Выведем для каждого
}
```
 
```
job = Jenkins.instance.getItemByFullName("My_Job_1")
job.getBuilds().each {
  if(it.result == Result.FAILURE){ // Удалим все результаты job, которые говорят об ошибке
   it.delete() // Удаляем результат
  }
}
```
 
```
job = Jenkins.instance.getItemByFullName("My_Job_1")

job.builds.each() { build ->  // Получаем поочередно все build 
 build.delete() // Удаляем вообще все результаты
}

job.updateNextBuildNumber(1) // Обновляем отсчет версий build, чтобы начинались с 1
```

# Pipeline
Jenkins pipeline - CI/CD в коде, использовать можно как Groovy (старые версии), так и Declarative language (язык, где ты указываешь что хочешь получить)

Работает он только через плагин pipelines, который нужно установить (установлен по умолчанию в стандартной сборке Jenkins)

Синтаксис выглядит так:
 
```
pipeline {
    agent any

    stages {
        stage('Test1') {
            steps {
                echo 'Test1 running'
            }
        }
        stage('Test2') {
            steps {
                echo 'Test2 running'
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deployed'
            }
        }
    }
}
```
 
Весь pipeline пишется в модуле pipeline, затем этапы разделяются в блоке stages. Agent используется для указания конкретной машины для запуска команд. В представленном коде 3 этапа: Test1, Test2, Deploy - команды же написаны в блоке steps (шаги)

Внутри шагов можно выполнять код Groovy или использовать команды оболочки через модуль sh:
 
```
pipeline {
    agent any

    stages {
        stage('Commands') {
            steps {
                sh "echo Небольшая команда"

		sh '''
		        echo Многомерная
		        echo Команда
		   '''
            }
        }
    }
}
```
 
В качестве агента могут выступать различные программы, главное не забыть установить их плагин, например Docker pipeline. Он позволяет запускать контейнера докера прямо через Jenkins, выполнять код pipeline, а затем удалять их

Вот пример:
 
```
pipeline {
    agent {
    docker {
        image 'python:latest'
      }
    }

    stages {
        stage('Commands') {
            steps {
                sh "python --version"
            }
        }
    }
}
```
 
Так же можно использовать переменные:
 
```
pipeline {
    agent any
    
    environment {
        OWNER = "ME"
    }

    stages {
        stage('Command') {
            steps {
                echo "${OWNER}"
            }
        }
    }
}
```

Помимо этого, JenkinsFile можно получать и с GitHub,ь для этого нужно указать не Pipeline Script, а Pipeline Script from SCM. Далее указываем git, ссылку на репозиторий и наш секретный ключ (как мы делали до этого), таким образом можно получать Jenkinsfile из репозиториев для быстрой интеграции и тестирования

С помощью Pipeline можно сделать очень много, главное уметь писать на его языке и знать как использовать различные плагины


# [Источник](https://www.youtube.com/playlist?list=PLg5SS_4L6LYvQbMrSuOjTL1HOiDhUE_5a)
В качестве источника представлен плейлист на ютубе